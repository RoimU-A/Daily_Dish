# Daily Dish ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­è¨ˆæ›¸ï¼ˆv2ï¼‰

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…

### 1.1 ğŸ†• å®Œå…¨DDLã‚³ãƒ¼ãƒ‰ï¼ˆv2ä»•æ§˜ï¼‰

```sql
-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
CREATE DATABASE DailyDish;
USE DailyDish;

-- usersãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE users (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    username NVARCHAR(150) NOT NULL UNIQUE,
    email NVARCHAR(254) NOT NULL UNIQUE,
    password NVARCHAR(128) NOT NULL,
    first_name NVARCHAR(150) NULL,
    last_name NVARCHAR(150) NULL,
    is_active BIT DEFAULT 1,
    is_staff BIT DEFAULT 0,
    is_superuser BIT DEFAULT 0,
    date_joined DATETIME2 DEFAULT GETDATE(),
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE()
);

-- ğŸ†• recipesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆçµ±ä¸€ç®¡ç†ï¼‰
CREATE TABLE recipes (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    recipe_name NVARCHAR(255) NOT NULL,
    recipe_url NVARCHAR(500) NULL,  -- ğŸ†• URLãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
    
    ingredient_1 NVARCHAR(100) NULL, amount_1 DECIMAL(10,1) NULL, unit_1 NVARCHAR(20) NULL,
    ingredient_2 NVARCHAR(100) NULL, amount_2 DECIMAL(10,1) NULL, unit_2 NVARCHAR(20) NULL,
    ingredient_3 NVARCHAR(100) NULL, amount_3 DECIMAL(10,1) NULL, unit_3 NVARCHAR(20) NULL,
    ingredient_4 NVARCHAR(100) NULL, amount_4 DECIMAL(10,1) NULL, unit_4 NVARCHAR(20) NULL,
    ingredient_5 NVARCHAR(100) NULL, amount_5 DECIMAL(10,1) NULL, unit_5 NVARCHAR(20) NULL,
    ingredient_6 NVARCHAR(100) NULL, amount_6 DECIMAL(10,1) NULL, unit_6 NVARCHAR(20) NULL,
    ingredient_7 NVARCHAR(100) NULL, amount_7 DECIMAL(10,1) NULL, unit_7 NVARCHAR(20) NULL,
    ingredient_8 NVARCHAR(100) NULL, amount_8 DECIMAL(10,1) NULL, unit_8 NVARCHAR(20) NULL,
    ingredient_9 NVARCHAR(100) NULL, amount_9 DECIMAL(10,1) NULL, unit_9 NVARCHAR(20) NULL,
    ingredient_10 NVARCHAR(100) NULL, amount_10 DECIMAL(10,1) NULL, unit_10 NVARCHAR(20) NULL,
    ingredient_11 NVARCHAR(100) NULL, amount_11 DECIMAL(10,1) NULL, unit_11 NVARCHAR(20) NULL,
    ingredient_12 NVARCHAR(100) NULL, amount_12 DECIMAL(10,1) NULL, unit_12 NVARCHAR(20) NULL,
    ingredient_13 NVARCHAR(100) NULL, amount_13 DECIMAL(10,1) NULL, unit_13 NVARCHAR(20) NULL,
    ingredient_14 NVARCHAR(100) NULL, amount_14 DECIMAL(10,1) NULL, unit_14 NVARCHAR(20) NULL,
    ingredient_15 NVARCHAR(100) NULL, amount_15 DECIMAL(10,1) NULL, unit_15 NVARCHAR(20) NULL,
    ingredient_16 NVARCHAR(100) NULL, amount_16 DECIMAL(10,1) NULL, unit_16 NVARCHAR(20) NULL,
    ingredient_17 NVARCHAR(100) NULL, amount_17 DECIMAL(10,1) NULL, unit_17 NVARCHAR(20) NULL,
    ingredient_18 NVARCHAR(100) NULL, amount_18 DECIMAL(10,1) NULL, unit_18 NVARCHAR(20) NULL,
    ingredient_19 NVARCHAR(100) NULL, amount_19 DECIMAL(10,1) NULL, unit_19 NVARCHAR(20) NULL,
    ingredient_20 NVARCHAR(100) NULL, amount_20 DECIMAL(10,1) NULL, unit_20 NVARCHAR(20) NULL,
    
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- âŒ registered_recipesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‰Šé™¤ï¼‰
-- æ©Ÿèƒ½ã¯ recipes ãƒ†ãƒ¼ãƒ–ãƒ«ã«çµ±åˆ

-- ğŸ”„ cooked_dishesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‚ç…§å…ˆå¤‰æ›´ï¼‰
CREATE TABLE cooked_dishes (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    recipe_id BIGINT NOT NULL,  -- ğŸ”„ registered_recipe_id ã‹ã‚‰å¤‰æ›´
    created_at DATETIME2 DEFAULT GETDATE(),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE  -- ğŸ”„ å‚ç…§å…ˆå¤‰æ›´
);

-- ingredient_cacheãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
CREATE TABLE ingredient_cache (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    ingredient_name NVARCHAR(100) NOT NULL,
    amount DECIMAL(10,1) NOT NULL,
    unit NVARCHAR(20) NOT NULL,
    created_at DATETIME2 DEFAULT GETDATE(),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE(user_id, ingredient_name)
);

-- api_keysãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆAPI Keyèªè¨¼ï¼‰
CREATE TABLE api_keys (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    key_name NVARCHAR(100) NOT NULL,
    api_key NVARCHAR(255) NOT NULL UNIQUE,
    is_active BIT DEFAULT 1,
    created_at DATETIME2 DEFAULT GETDATE(),
    expires_at DATETIME2 NULL,
    last_used_at DATETIME2 NULL,
    usage_count INT DEFAULT 0
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_recipes_user_id ON recipes(user_id);
CREATE INDEX idx_recipes_created_at ON recipes(created_at);
CREATE INDEX idx_cooked_dishes_user_id ON cooked_dishes(user_id);
CREATE INDEX idx_cooked_dishes_recipe_id ON cooked_dishes(recipe_id);
CREATE INDEX idx_ingredient_cache_user_id ON ingredient_cache(user_id);
CREATE INDEX idx_api_keys_api_key ON api_keys(api_key);
CREATE INDEX idx_api_keys_is_active ON api_keys(is_active);
```

### 1.2 ğŸ”„ ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```sql
-- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰v2ã¸ã®ç§»è¡Œ

-- 1. recipesãƒ†ãƒ¼ãƒ–ãƒ«ã«URLã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE recipes ADD recipe_url NVARCHAR(500) NULL;

-- 2. cooked_dishesãƒ†ãƒ¼ãƒ–ãƒ«ã«recipe_idã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE cooked_dishes ADD recipe_id BIGINT NULL;

-- 3. æ—¢å­˜ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œ
INSERT INTO recipes (user_id, recipe_name, recipe_url, created_at)
SELECT user_id, recipe_name, recipe_url, created_at
FROM registered_recipes
WHERE recipe_type = 'existing';

-- 4. cooked_dishesã®å¤–éƒ¨ã‚­ãƒ¼ã‚’æ›´æ–°
-- newå‹ã®å ´åˆ
UPDATE cd 
SET cd.recipe_id = rr.recipe_id
FROM cooked_dishes cd
JOIN registered_recipes rr ON cd.registered_recipe_id = rr.id
WHERE rr.recipe_type = 'new';

-- existingå‹ã®å ´åˆï¼ˆæ–°ã—ãä½œæˆã•ã‚ŒãŸãƒ¬ã‚·ãƒ”IDã‚’ä½¿ç”¨ï¼‰
UPDATE cd 
SET cd.recipe_id = r.id
FROM cooked_dishes cd
JOIN registered_recipes rr ON cd.registered_recipe_id = rr.id
JOIN recipes r ON rr.recipe_name = r.recipe_name AND rr.recipe_url = r.recipe_url
WHERE rr.recipe_type = 'existing';

-- 5. åˆ¶ç´„ã‚’è¿½åŠ 
ALTER TABLE cooked_dishes ADD CONSTRAINT fk_cooked_dishes_recipe_id 
FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE;

-- 6. å¤ã„ã‚«ãƒ©ãƒ ã¨åˆ¶ç´„ã‚’å‰Šé™¤
ALTER TABLE cooked_dishes DROP CONSTRAINT fk_cooked_dishes_registered_recipe_id;
ALTER TABLE cooked_dishes DROP COLUMN registered_recipe_id;

-- 7. registered_recipesãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
DROP TABLE registered_recipes;
```

## 2. Django ãƒ¢ãƒ‡ãƒ«å®Ÿè£…

### 2.1 ğŸ†• models.pyï¼ˆv2ä»•æ§˜ï¼‰

```python
from django.db import models
from django.contrib.auth.models import AbstractUser
from django.core.exceptions import ValidationError
from decimal import Decimal


class User(AbstractUser):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«"""
    email = models.EmailField(unique=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'users'


class Recipe(models.Model):
    """çµ±ä¸€ãƒ¬ã‚·ãƒ”ãƒ¢ãƒ‡ãƒ«ï¼ˆæ—¢å­˜ãƒ»æ–°è¦ä¸¡æ–¹å¯¾å¿œï¼‰"""
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    recipe_name = models.CharField(max_length=255)
    recipe_url = models.URLField(max_length=500, null=True, blank=True)  # ğŸ†• URLãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    
    # ææ–™1-20ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    ingredient_1 = models.CharField(max_length=100, null=True, blank=True)
    amount_1 = models.DecimalField(max_digits=10, decimal_places=1, null=True, blank=True)
    unit_1 = models.CharField(max_length=20, null=True, blank=True)
    
    ingredient_2 = models.CharField(max_length=100, null=True, blank=True)
    amount_2 = models.DecimalField(max_digits=10, decimal_places=1, null=True, blank=True)
    unit_2 = models.CharField(max_length=20, null=True, blank=True)
    
    # ... ingredient_3 to ingredient_20 (åŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³)
    
    ingredient_20 = models.CharField(max_length=100, null=True, blank=True)
    amount_20 = models.DecimalField(max_digits=10, decimal_places=1, null=True, blank=True)
    unit_20 = models.CharField(max_length=20, null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'recipes'
        indexes = [
            models.Index(fields=['user']),
            models.Index(fields=['created_at']),
        ]
    
    def get_ingredients(self):
        """ææ–™ãƒªã‚¹ãƒˆã‚’å–å¾—"""
        ingredients = []
        for i in range(1, 21):
            name = getattr(self, f'ingredient_{i}')
            amount = getattr(self, f'amount_{i}')
            unit = getattr(self, f'unit_{i}')
            
            if name and amount and unit:
                ingredients.append({
                    'name': name,
                    'amount': float(amount),
                    'unit': unit
                })
        return ingredients
    
    def is_existing_recipe(self):
        """æ—¢å­˜ãƒ¬ã‚·ãƒ”ã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
        return self.recipe_url is not None
    
    def is_new_recipe(self):
        """æ–°è¦ãƒ¬ã‚·ãƒ”ã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
        return self.recipe_url is None
    
    def __str__(self):
        return f"{self.recipe_name} by {self.user.username}"


class CookedDish(models.Model):
    """æ–™ç†å±¥æ­´ãƒ¢ãƒ‡ãƒ«"""
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    recipe = models.ForeignKey(Recipe, on_delete=models.CASCADE)  # ğŸ”„ ç›´æ¥ãƒ¬ã‚·ãƒ”å‚ç…§
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'cooked_dishes'
        indexes = [
            models.Index(fields=['user']),
            models.Index(fields=['recipe']),
            models.Index(fields=['created_at']),
        ]
    
    def __str__(self):
        return f"{self.recipe.recipe_name} cooked by {self.user.username} at {self.created_at}"


class IngredientCache(models.Model):
    """é£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¢ãƒ‡ãƒ«"""
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    ingredient_name = models.CharField(max_length=100)
    amount = models.DecimalField(max_digits=10, decimal_places=1)
    unit = models.CharField(max_length=20)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'ingredient_cache'
        unique_together = ['user', 'ingredient_name']
        indexes = [
            models.Index(fields=['user']),
        ]
    
    def __str__(self):
        return f"{self.ingredient_name} {self.amount}{self.unit} for {self.user.username}"


class ApiKey(models.Model):
    """API Keyç®¡ç†ãƒ¢ãƒ‡ãƒ«"""
    key_name = models.CharField(max_length=100)
    api_key = models.CharField(max_length=255, unique=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField(null=True, blank=True)
    last_used_at = models.DateTimeField(null=True, blank=True)
    usage_count = models.IntegerField(default=0)
    
    class Meta:
        db_table = 'api_keys'
        indexes = [
            models.Index(fields=['api_key']),
            models.Index(fields=['is_active']),
        ]
    
    def __str__(self):
        return f"{self.key_name} ({'Active' if self.is_active else 'Inactive'})"
```

### 2.2 ğŸ†• ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼å®Ÿè£…

```python
from rest_framework import serializers
from django.contrib.auth import get_user_model
from .models import Recipe, CookedDish, IngredientCache, ApiKey

User = get_user_model()


class UserSerializer(serializers.ModelSerializer):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼"""
    
    class Meta:
        model = User
        fields = ['id', 'username', 'email', 'created_at', 'updated_at']
        read_only_fields = ['id', 'created_at', 'updated_at']


class RecipeSerializer(serializers.ModelSerializer):
    """çµ±ä¸€ãƒ¬ã‚·ãƒ”ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼"""
    ingredients = serializers.SerializerMethodField(read_only=True)
    user = serializers.StringRelatedField(read_only=True)
    is_existing_recipe = serializers.BooleanField(read_only=True)
    is_new_recipe = serializers.BooleanField(read_only=True)
    
    class Meta:
        model = Recipe
        fields = ['id', 'user', 'recipe_name', 'recipe_url', 'ingredients', 
                 'is_existing_recipe', 'is_new_recipe', 'created_at', 'updated_at'] + \
                [f'ingredient_{i}' for i in range(1, 21)] + \
                [f'amount_{i}' for i in range(1, 21)] + \
                [f'unit_{i}' for i in range(1, 21)]
        read_only_fields = ['id', 'user', 'created_at', 'updated_at']
    
    def get_ingredients(self, obj):
        """ææ–™ãƒªã‚¹ãƒˆã‚’å–å¾—"""
        return obj.get_ingredients()
    
    def create(self, validated_data):
        """ãƒ¬ã‚·ãƒ”ä½œæˆæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•è¨­å®š"""
        validated_data['user'] = self.context['request'].user
        return super().create(validated_data)
    
    def validate(self, attrs):
        """ãƒ¬ã‚·ãƒ”ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³"""
        # æœ€ä½1ã¤ã®ææ–™ã¯å¿…è¦
        has_ingredient = False
        for i in range(1, 21):
            name = attrs.get(f'ingredient_{i}')
            amount = attrs.get(f'amount_{i}')
            unit = attrs.get(f'unit_{i}')
            
            if name and amount and unit:
                has_ingredient = True
                break
        
        if not has_ingredient:
            raise serializers.ValidationError('æœ€ä½1ã¤ã®ææ–™ã¯å¿…è¦ã§ã™')
        
        return attrs


class CookedDishSerializer(serializers.ModelSerializer):
    """æ–™ç†å±¥æ­´ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼"""
    user = serializers.StringRelatedField(read_only=True)
    recipe_detail = RecipeSerializer(source='recipe', read_only=True)
    
    class Meta:
        model = CookedDish
        fields = ['id', 'user', 'recipe', 'recipe_detail', 'created_at']
        read_only_fields = ['id', 'user', 'created_at']
    
    def create(self, validated_data):
        """æ–™ç†å±¥æ­´ä½œæˆæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•è¨­å®š"""
        validated_data['user'] = self.context['request'].user
        return super().create(validated_data)
    
    def validate_recipe(self, value):
        """ãƒ¬ã‚·ãƒ”ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯"""
        request = self.context.get('request')
        if request and value.user != request.user:
            raise serializers.ValidationError('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¬ã‚·ãƒ”ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“')
        return value


class IngredientCacheSerializer(serializers.ModelSerializer):
    """é£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼"""
    user = serializers.StringRelatedField(read_only=True)
    
    class Meta:
        model = IngredientCache
        fields = ['id', 'user', 'ingredient_name', 'amount', 'unit', 'created_at']
        read_only_fields = ['id', 'user', 'created_at']
    
    def create(self, validated_data):
        """é£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½œæˆæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•è¨­å®š"""
        validated_data['user'] = self.context['request'].user
        return super().create(validated_data)


# å¤–éƒ¨ã‚¢ãƒ—ãƒªå‘ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼
class ExternalRecipeSerializer(serializers.ModelSerializer):
    """å¤–éƒ¨ã‚¢ãƒ—ãƒªå‘ã‘ãƒ¬ã‚·ãƒ”ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼"""
    ingredients = serializers.SerializerMethodField(read_only=True)
    
    class Meta:
        model = Recipe
        fields = ['id', 'recipe_name', 'recipe_url', 'ingredients', 'created_at']
        read_only_fields = ['id', 'created_at']
    
    def get_ingredients(self, obj):
        return obj.get_ingredients()
```

### 2.3 ğŸ†• APIãƒ“ãƒ¥ãƒ¼å®Ÿè£…

```python
from rest_framework import generics, status
from rest_framework.response import Response
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from django.contrib.auth import get_user_model
from .models import Recipe, CookedDish, IngredientCache
from .serializers import (
    UserSerializer, RecipeSerializer, CookedDishSerializer,
    IngredientCacheSerializer, ExternalRecipeSerializer
)
from .permissions import IsJWTAuthenticated, IsOwner, IsApiKeyAuthenticated
from .authentication import HybridAuthentication, ApiKeyAuthentication

User = get_user_model()


# Web API (JWTèªè¨¼)
class RecipeListCreateView(generics.ListCreateAPIView):
    """
    çµ±ä¸€ãƒ¬ã‚·ãƒ”ä¸€è¦§ãƒ»ä½œæˆAPI
    GET/POST /api/web/recipes/
    """
    serializer_class = RecipeSerializer
    authentication_classes = [HybridAuthentication]
    permission_classes = [IsJWTAuthenticated]
    
    def get_queryset(self):
        # ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¬ã‚·ãƒ”ã®ã¿å–å¾—
        return Recipe.objects.filter(user=self.request.user).order_by('-created_at')


class RecipeDetailView(generics.RetrieveUpdateDestroyAPIView):
    """
    ãƒ¬ã‚·ãƒ”è©³ç´°ãƒ»æ›´æ–°ãƒ»å‰Šé™¤API
    GET/PUT/PATCH/DELETE /api/web/recipes/{id}/
    """
    serializer_class = RecipeSerializer
    authentication_classes = [HybridAuthentication]
    permission_classes = [IsJWTAuthenticated, IsOwner]
    
    def get_queryset(self):
        return Recipe.objects.filter(user=self.request.user)


class CookedDishListCreateView(generics.ListCreateAPIView):
    """
    æ–™ç†å±¥æ­´ä¸€è¦§ãƒ»ä½œæˆAPI
    GET/POST /api/web/cooked-dishes/
    """
    serializer_class = CookedDishSerializer
    authentication_classes = [HybridAuthentication]
    permission_classes = [IsJWTAuthenticated]
    
    def get_queryset(self):
        return CookedDish.objects.filter(user=self.request.user).order_by('-created_at')


class CookedDishDetailView(generics.RetrieveDestroyAPIView):
    """
    æ–™ç†å±¥æ­´è©³ç´°ãƒ»å‰Šé™¤API
    GET/DELETE /api/web/cooked-dishes/{id}/
    """
    serializer_class = CookedDishSerializer
    authentication_classes = [HybridAuthentication]
    permission_classes = [IsJWTAuthenticated, IsOwner]
    
    def get_queryset(self):
        return CookedDish.objects.filter(user=self.request.user)


class IngredientCacheListCreateView(generics.ListCreateAPIView):
    """
    é£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸€è¦§ãƒ»ä½œæˆAPI
    GET/POST /api/web/ingredient-cache/
    """
    serializer_class = IngredientCacheSerializer
    authentication_classes = [HybridAuthentication]
    permission_classes = [IsJWTAuthenticated]
    
    def get_queryset(self):
        return IngredientCache.objects.filter(user=self.request.user).order_by('-created_at')


# å¤–éƒ¨API (API Keyèªè¨¼)
class ExternalRecipeListView(generics.ListAPIView):
    """
    å¤–éƒ¨ã‚¢ãƒ—ãƒªå‘ã‘ãƒ¬ã‚·ãƒ”ä¸€è¦§API
    GET /api/external/recipes/
    """
    serializer_class = ExternalRecipeSerializer
    authentication_classes = [ApiKeyAuthentication]
    permission_classes = [IsApiKeyAuthenticated]
    
    def get_queryset(self):
        return Recipe.objects.all().order_by('-created_at')


@api_view(['GET'])
@permission_classes([IsApiKeyAuthenticated])
def external_stats_view(request):
    """
    å¤–éƒ¨ã‚¢ãƒ—ãƒªå‘ã‘çµ±è¨ˆæƒ…å ±API
    GET /api/external/stats/
    """
    stats = {
        'total_recipes': Recipe.objects.count(),
        'total_users': User.objects.count(),
        'total_cooked_dishes': CookedDish.objects.count(),
        'total_ingredient_cache': IngredientCache.objects.count(),
    }
    
    return Response(stats)
```

### 2.4 ğŸ†• URLè¨­å®š

```python
from django.urls import path, include
from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView
from . import views_web, views_external

app_name = 'daily_dish'

# Web APIç”¨ã®URLè¨­å®š
web_patterns = [
    # èªè¨¼é–¢é€£
    path('auth/login/', TokenObtainPairView.as_view(), name='web_login'),
    path('auth/refresh/', TokenRefreshView.as_view(), name='web_refresh'),
    path('auth/register/', views_web.UserCreateView.as_view(), name='web_register'),
    path('auth/profile/', views_web.UserProfileView.as_view(), name='web_profile'),
    
    # çµ±ä¸€ãƒ¬ã‚·ãƒ”ç®¡ç†
    path('recipes/', views_web.RecipeListCreateView.as_view(), name='web_recipe_list'),
    path('recipes/<int:pk>/', views_web.RecipeDetailView.as_view(), name='web_recipe_detail'),
    
    # æ–™ç†å±¥æ­´ç®¡ç†
    path('cooked-dishes/', views_web.CookedDishListCreateView.as_view(), name='web_cooked_dish_list'),
    path('cooked-dishes/<int:pk>/', views_web.CookedDishDetailView.as_view(), name='web_cooked_dish_detail'),
    
    # é£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
    path('ingredient-cache/', views_web.IngredientCacheListCreateView.as_view(), name='web_ingredient_cache_list'),
    path('ingredient-cache/<int:pk>/', views_web.IngredientCacheDetailView.as_view(), name='web_ingredient_cache_detail'),
    
    # çµ±è¨ˆãƒ»åˆ†æ
    path('stats/', views_web.user_stats_view, name='web_stats'),
    path('dashboard/', views_web.user_dashboard_view, name='web_dashboard'),
]

# å¤–éƒ¨APIç”¨ã®URLè¨­å®š
external_patterns = [
    # ãƒ¬ã‚·ãƒ”æƒ…å ±ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
    path('recipes/', views_external.ExternalRecipeListView.as_view(), name='external_recipe_list'),
    path('recipes/<int:pk>/', views_external.ExternalRecipeDetailView.as_view(), name='external_recipe_detail'),
    
    # çµ±è¨ˆæƒ…å ±
    path('stats/', views_external.external_stats_view, name='external_stats'),
]

# ãƒ¡ã‚¤ãƒ³ã®URLè¨­å®š
urlpatterns = [
    path('api/web/', include(web_patterns)),
    path('api/external/', include(external_patterns)),
]
```

### 2.5 ğŸ†• ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```python
# daily_dish/migrations/0002_recipe_url_cooked_dish_recipe_v2.py

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('daily_dish', '0001_initial'),
    ]

    operations = [
        # 1. recipesãƒ†ãƒ¼ãƒ–ãƒ«ã«recipe_urlãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
        migrations.AddField(
            model_name='recipe',
            name='recipe_url',
            field=models.URLField(blank=True, max_length=500, null=True),
        ),
        
        # 2. cooked_dishesãƒ†ãƒ¼ãƒ–ãƒ«ã«recipeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
        migrations.AddField(
            model_name='cookeddish',
            name='recipe',
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                to='daily_dish.recipe'
            ),
        ),
        
        # 3. registered_recipesãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
        migrations.DeleteModel(
            name='RegisteredRecipe',
        ),
        
        # 4. cooked_dishesã®registered_recipeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
        migrations.RemoveField(
            model_name='cookeddish',
            name='registered_recipe',
        ),
        
        # 5. recipe ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…é ˆã«å¤‰æ›´
        migrations.AlterField(
            model_name='cookeddish',
            name='recipe',
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                to='daily_dish.recipe'
            ),
        ),
    ]
```

### 2.6 ğŸ†• ãƒ†ã‚¹ãƒˆå®Ÿè£…

```python
# daily_dish/test_api_v2.py

from django.test import TestCase
from django.urls import reverse
from rest_framework.test import APITestCase
from rest_framework import status
from django.contrib.auth import get_user_model
from decimal import Decimal

from .models import Recipe, CookedDish, IngredientCache, ApiKey

User = get_user_model()


class UnifiedRecipeAPITest(APITestCase):
    """çµ±ä¸€ãƒ¬ã‚·ãƒ”APIãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpassword123'
        )
        
        # JWTèªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³
        login_url = reverse('daily_dish:web_login')
        login_data = {
            'username': 'testuser',
            'password': 'testpassword123'
        }
        login_response = self.client.post(login_url, login_data)
        access_token = login_response.data['access']
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {access_token}')
    
    def test_create_existing_recipe(self):
        """æ—¢å­˜ãƒ¬ã‚·ãƒ”ä½œæˆãƒ†ã‚¹ãƒˆ"""
        url = reverse('daily_dish:web_recipe_list')
        data = {
            'recipe_name': 'ã‚¯ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã®ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼',
            'recipe_url': 'https://cookpad.com/recipe/123456',
            'ingredient_1': 'é¶è‚‰',
            'amount_1': '300.0',
            'unit_1': 'g',
            'ingredient_2': 'ç‰ã­ã',
            'amount_2': '200.0',
            'unit_2': 'g'
        }
        
        response = self.client.post(url, data)
        
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(response.data['recipe_name'], 'ã‚¯ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã®ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼')
        self.assertEqual(response.data['recipe_url'], 'https://cookpad.com/recipe/123456')
        self.assertTrue(response.data['is_existing_recipe'])
        self.assertFalse(response.data['is_new_recipe'])
    
    def test_create_new_recipe(self):
        """æ–°è¦ãƒ¬ã‚·ãƒ”ä½œæˆãƒ†ã‚¹ãƒˆ"""
        url = reverse('daily_dish:web_recipe_list')
        data = {
            'recipe_name': 'æ‰‹ä½œã‚Šãƒãƒ³ãƒãƒ¼ã‚°',
            'ingredient_1': 'ç‰›ã²ãè‚‰',
            'amount_1': '400.0',
            'unit_1': 'g',
            'ingredient_2': 'ç‰ã­ã',
            'amount_2': '150.0',
            'unit_2': 'g'
        }
        
        response = self.client.post(url, data)
        
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(response.data['recipe_name'], 'æ‰‹ä½œã‚Šãƒãƒ³ãƒãƒ¼ã‚°')
        self.assertIsNone(response.data['recipe_url'])
        self.assertFalse(response.data['is_existing_recipe'])
        self.assertTrue(response.data['is_new_recipe'])
    
    def test_recipe_ingredients_processing(self):
        """ææ–™å‡¦ç†ãƒ†ã‚¹ãƒˆ"""
        recipe = Recipe.objects.create(
            user=self.user,
            recipe_name='ãƒ†ã‚¹ãƒˆãƒ¬ã‚·ãƒ”',
            ingredient_1='ææ–™1',
            amount_1=Decimal('100.0'),
            unit_1='g',
            ingredient_2='ææ–™2',
            amount_2=Decimal('200.0'),
            unit_2='ml'
        )
        
        ingredients = recipe.get_ingredients()
        
        self.assertEqual(len(ingredients), 2)
        self.assertEqual(ingredients[0]['name'], 'ææ–™1')
        self.assertEqual(ingredients[0]['amount'], 100.0)
        self.assertEqual(ingredients[0]['unit'], 'g')


class CookedDishAPITest(APITestCase):
    """æ–™ç†å±¥æ­´APIãƒ†ã‚¹ãƒˆï¼ˆç°¡ç•¥åŒ–ï¼‰"""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpassword123'
        )
        
        self.recipe = Recipe.objects.create(
            user=self.user,
            recipe_name='ãƒ†ã‚¹ãƒˆãƒ¬ã‚·ãƒ”',
            ingredient_1='ææ–™1',
            amount_1=Decimal('100.0'),
            unit_1='g'
        )
        
        # JWTèªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³
        login_url = reverse('daily_dish:web_login')
        login_data = {
            'username': 'testuser',
            'password': 'testpassword123'
        }
        login_response = self.client.post(login_url, login_data)
        access_token = login_response.data['access']
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {access_token}')
    
    def test_create_cooked_dish(self):
        """æ–™ç†å±¥æ­´ä½œæˆãƒ†ã‚¹ãƒˆ"""
        url = reverse('daily_dish:web_cooked_dish_list')
        data = {
            'recipe': self.recipe.id
        }
        
        response = self.client.post(url, data)
        
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(response.data['recipe'], self.recipe.id)
        self.assertEqual(response.data['recipe_detail']['recipe_name'], 'ãƒ†ã‚¹ãƒˆãƒ¬ã‚·ãƒ”')
```

## 3. å®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 3.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´
- [x] recipes ãƒ†ãƒ¼ãƒ–ãƒ«ã« recipe_url ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- [x] cooked_dishes ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼å¤‰æ›´
- [x] registered_recipes ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤
- [x] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†æ§‹ç¯‰

### 3.2 ãƒ¢ãƒ‡ãƒ«å¤‰æ›´
- [x] Recipe ãƒ¢ãƒ‡ãƒ«ã« recipe_url ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- [x] Recipe ãƒ¢ãƒ‡ãƒ«ã« is_existing_recipe(), is_new_recipe() ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- [x] RegisteredRecipe ãƒ¢ãƒ‡ãƒ«å‰Šé™¤
- [x] CookedDish ãƒ¢ãƒ‡ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼å¤‰æ›´

### 3.3 ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼å¤‰æ›´
- [x] RecipeSerializer ã®çµ±ä¸€åŒ–
- [x] CookedDishSerializer ã®ç°¡ç•¥åŒ–
- [x] RegisteredRecipeSerializer å‰Šé™¤

### 3.4 APIå¤‰æ›´
- [x] çµ±ä¸€ãƒ¬ã‚·ãƒ” API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- [x] æ–™ç†å±¥æ­´ API ã®ç°¡ç•¥åŒ–
- [x] URLè¨­å®šã®çµ±ä¸€åŒ–

### 3.5 ãƒ†ã‚¹ãƒˆå¤‰æ›´
- [x] çµ±ä¸€ãƒ¬ã‚·ãƒ”ãƒ†ã‚¹ãƒˆã®å®Ÿè£…
- [x] æ–™ç†å±¥æ­´ãƒ†ã‚¹ãƒˆã®ä¿®æ­£
- [x] èªè¨¼ãƒ†ã‚¹ãƒˆã®ç¢ºèª

---

**æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­è¨ˆæ›¸ï¼ˆv2ï¼‰ã¯çµ±ä¸€ã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨ãªå®Ÿè£…ã‚¬ã‚¤ãƒ‰ã¨ã—ã¦æ´»ç”¨ã™ã‚‹**