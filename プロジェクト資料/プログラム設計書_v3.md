# Daily Dish ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­è¨ˆæ›¸ï¼ˆv3ï¼‰

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…

### 1.1 ğŸ†• å®Œå…¨DDLã‚³ãƒ¼ãƒ‰ï¼ˆv3ä»•æ§˜ - LINEé€£æºå¯¾å¿œï¼‰

```sql
-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
CREATE DATABASE DailyDish;
USE DailyDish;

-- ğŸ†• usersãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆLINEé€£æºå¯¾å¿œï¼‰
CREATE TABLE users (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    username NVARCHAR(150) NOT NULL UNIQUE,
    email NVARCHAR(254) NOT NULL UNIQUE,
    password NVARCHAR(128) NOT NULL,
    line_user_id NVARCHAR(100) NULL UNIQUE,  -- ğŸ†• LINEé€£æºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    first_name NVARCHAR(150) NULL,
    last_name NVARCHAR(150) NULL,
    is_active BIT DEFAULT 1,
    is_staff BIT DEFAULT 0,
    is_superuser BIT DEFAULT 0,
    date_joined DATETIME2 DEFAULT GETDATE(),
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE()
);

-- recipesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆçµ±ä¸€ç®¡ç†ãƒ»å¤‰æ›´ãªã—ï¼‰
CREATE TABLE recipes (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    recipe_name NVARCHAR(255) NOT NULL,
    recipe_url NVARCHAR(500) NULL,
    
    ingredient_1 NVARCHAR(100) NULL, amount_1 DECIMAL(10,1) NULL, unit_1 NVARCHAR(20) NULL,
    ingredient_2 NVARCHAR(100) NULL, amount_2 DECIMAL(10,1) NULL, unit_2 NVARCHAR(20) NULL,
    ingredient_3 NVARCHAR(100) NULL, amount_3 DECIMAL(10,1) NULL, unit_3 NVARCHAR(20) NULL,
    ingredient_4 NVARCHAR(100) NULL, amount_4 DECIMAL(10,1) NULL, unit_4 NVARCHAR(20) NULL,
    ingredient_5 NVARCHAR(100) NULL, amount_5 DECIMAL(10,1) NULL, unit_5 NVARCHAR(20) NULL,
    ingredient_6 NVARCHAR(100) NULL, amount_6 DECIMAL(10,1) NULL, unit_6 NVARCHAR(20) NULL,
    ingredient_7 NVARCHAR(100) NULL, amount_7 DECIMAL(10,1) NULL, unit_7 NVARCHAR(20) NULL,
    ingredient_8 NVARCHAR(100) NULL, amount_8 DECIMAL(10,1) NULL, unit_8 NVARCHAR(20) NULL,
    ingredient_9 NVARCHAR(100) NULL, amount_9 DECIMAL(10,1) NULL, unit_9 NVARCHAR(20) NULL,
    ingredient_10 NVARCHAR(100) NULL, amount_10 DECIMAL(10,1) NULL, unit_10 NVARCHAR(20) NULL,
    ingredient_11 NVARCHAR(100) NULL, amount_11 DECIMAL(10,1) NULL, unit_11 NVARCHAR(20) NULL,
    ingredient_12 NVARCHAR(100) NULL, amount_12 DECIMAL(10,1) NULL, unit_12 NVARCHAR(20) NULL,
    ingredient_13 NVARCHAR(100) NULL, amount_13 DECIMAL(10,1) NULL, unit_13 NVARCHAR(20) NULL,
    ingredient_14 NVARCHAR(100) NULL, amount_14 DECIMAL(10,1) NULL, unit_14 NVARCHAR(20) NULL,
    ingredient_15 NVARCHAR(100) NULL, amount_15 DECIMAL(10,1) NULL, unit_15 NVARCHAR(20) NULL,
    ingredient_16 NVARCHAR(100) NULL, amount_16 DECIMAL(10,1) NULL, unit_16 NVARCHAR(20) NULL,
    ingredient_17 NVARCHAR(100) NULL, amount_17 DECIMAL(10,1) NULL, unit_17 NVARCHAR(20) NULL,
    ingredient_18 NVARCHAR(100) NULL, amount_18 DECIMAL(10,1) NULL, unit_18 NVARCHAR(20) NULL,
    ingredient_19 NVARCHAR(100) NULL, amount_19 DECIMAL(10,1) NULL, unit_19 NVARCHAR(20) NULL,
    ingredient_20 NVARCHAR(100) NULL, amount_20 DECIMAL(10,1) NULL, unit_20 NVARCHAR(20) NULL,
    
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- cooked_dishesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰
CREATE TABLE cooked_dishes (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    recipe_id BIGINT NOT NULL,
    created_at DATETIME2 DEFAULT GETDATE(),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE
);

-- ingredient_cacheãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»å¤‰æ›´ãªã—ï¼‰
CREATE TABLE ingredient_cache (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    ingredient_name NVARCHAR(100) NOT NULL,
    amount DECIMAL(10,1) NOT NULL,
    unit NVARCHAR(20) NOT NULL,
    created_at DATETIME2 DEFAULT GETDATE(),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE(user_id, ingredient_name)
);

-- api_keysãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆAPI Keyèªè¨¼ãƒ»å¤‰æ›´ãªã—ï¼‰
CREATE TABLE api_keys (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    key_name NVARCHAR(100) NOT NULL,
    api_key NVARCHAR(255) NOT NULL UNIQUE,
    is_active BIT DEFAULT 1,
    created_at DATETIME2 DEFAULT GETDATE(),
    expires_at DATETIME2 NULL,
    last_used_at DATETIME2 NULL,
    usage_count INT DEFAULT 0
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_users_line_user_id ON users(line_user_id);  -- ğŸ†• LINEé€£æºç”¨
CREATE INDEX idx_recipes_user_id ON recipes(user_id);
CREATE INDEX idx_recipes_created_at ON recipes(created_at);
CREATE INDEX idx_cooked_dishes_user_id ON cooked_dishes(user_id);
CREATE INDEX idx_cooked_dishes_recipe_id ON cooked_dishes(recipe_id);
CREATE INDEX idx_ingredient_cache_user_id ON ingredient_cache(user_id);
CREATE INDEX idx_api_keys_api_key ON api_keys(api_key);
CREATE INDEX idx_api_keys_is_active ON api_keys(is_active);
```

### 1.2 ğŸ†• v3ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```sql
-- v2ã‹ã‚‰v3ã¸ã®ç§»è¡Œï¼ˆLINEé€£æºå¯¾å¿œï¼‰

-- 1. usersãƒ†ãƒ¼ãƒ–ãƒ«ã«LINEé€£æºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
ALTER TABLE users ADD line_user_id NVARCHAR(100) NULL;

-- 2. LINEé€£æºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„è¿½åŠ 
ALTER TABLE users ADD CONSTRAINT uq_users_line_user_id UNIQUE (line_user_id);

-- 3. LINEé€£æºç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_users_line_user_id ON users(line_user_id);

-- ç¢ºèªç”¨ã‚¯ã‚¨ãƒª
SELECT 
    COLUMN_NAME, 
    DATA_TYPE, 
    IS_NULLABLE, 
    COLUMN_DEFAULT
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'users' 
    AND COLUMN_NAME = 'line_user_id';
```

## 2. Djangoãƒ¢ãƒ‡ãƒ«å®Ÿè£…

### 2.1 ğŸ†• models.pyï¼ˆv3ä»•æ§˜ï¼‰

```python
# daily_dish/models.py
from django.contrib.auth.models import AbstractUser
from django.db import models
from django.core.exceptions import ValidationError
import re

class User(AbstractUser):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ï¼ˆLINEé€£æºå¯¾å¿œï¼‰"""
    email = models.EmailField(unique=True)
    line_user_id = models.CharField(  # ğŸ†• LINEé€£æºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        max_length=100, 
        unique=True, 
        null=True, 
        blank=True,
        help_text="LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆé€£æºæ™‚ã«è¨­å®šï¼‰"
    )
    
    USERNAME_FIELD = 'username'
    REQUIRED_FIELDS = ['email']
    
    def clean(self):
        """LINEé€£æºã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯"""
        super().clean()
        if self.line_user_id:
            # LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å½¢å¼ãƒã‚§ãƒƒã‚¯
            if not re.match(r'^U[0-9a-f]{32}$', self.line_user_id):
                raise ValidationError({
                    'line_user_id': 'LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'
                })
    
    @property
    def is_line_linked(self):
        """LINEé€£æºçŠ¶æ…‹ã®ç¢ºèª"""
        return bool(self.line_user_id)
    
    def __str__(self):
        return self.username

class Recipe(models.Model):
    """ãƒ¬ã‚·ãƒ”ãƒ¢ãƒ‡ãƒ«ï¼ˆçµ±ä¸€ç®¡ç†ãƒ»å¤‰æ›´ãªã—ï¼‰"""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='recipes')
    recipe_name = models.CharField(max_length=255)
    recipe_url = models.URLField(max_length=500, blank=True, null=True)
    
    # ææ–™ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆ1-20ï¼‰
    ingredient_1 = models.CharField(max_length=100, blank=True, null=True)
    amount_1 = models.DecimalField(max_digits=10, decimal_places=1, blank=True, null=True)
    unit_1 = models.CharField(max_length=20, blank=True, null=True)
    
    ingredient_2 = models.CharField(max_length=100, blank=True, null=True)
    amount_2 = models.DecimalField(max_digits=10, decimal_places=1, blank=True, null=True)
    unit_2 = models.CharField(max_length=20, blank=True, null=True)
    
    # ... ingredient_3 to ingredient_20 (åŒæ§˜ã®æ§‹é€ )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    @property
    def is_existing_recipe(self):
        """æ—¢å­˜ãƒ¬ã‚·ãƒ”ã‹ã©ã†ã‹ã®åˆ¤å®š"""
        return bool(self.recipe_url)
    
    @property
    def is_new_recipe(self):
        """æ–°è¦ãƒ¬ã‚·ãƒ”ã‹ã©ã†ã‹ã®åˆ¤å®š"""
        return not bool(self.recipe_url)
    
    @property
    def ingredients(self):
        """ææ–™æƒ…å ±ã®å–å¾—"""
        ingredients = []
        for i in range(1, 21):
            ingredient_name = getattr(self, f'ingredient_{i}')
            amount = getattr(self, f'amount_{i}')
            unit = getattr(self, f'unit_{i}')
            
            if ingredient_name:
                ingredients.append({
                    'name': ingredient_name,
                    'amount': float(amount) if amount else 0.0,
                    'unit': unit or ''
                })
        return ingredients
    
    def set_ingredients(self, ingredients_data):
        """ææ–™æƒ…å ±ã®è¨­å®šï¼ˆLINEå…¥åŠ›å¯¾å¿œï¼‰"""
        # æ—¢å­˜ã®ææ–™ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        for i in range(1, 21):
            setattr(self, f'ingredient_{i}', None)
            setattr(self, f'amount_{i}', None)
            setattr(self, f'unit_{i}', None)
        
        # æ–°ã—ã„ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        for i, ingredient in enumerate(ingredients_data[:20], 1):
            setattr(self, f'ingredient_{i}', ingredient.get('name'))
            setattr(self, f'amount_{i}', ingredient.get('amount'))
            setattr(self, f'unit_{i}', ingredient.get('unit'))
    
    def __str__(self):
        return self.recipe_name
    
    class Meta:
        ordering = ['-created_at']

class CookedDish(models.Model):
    """æ–™ç†å±¥æ­´ãƒ¢ãƒ‡ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰"""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='cooked_dishes')
    recipe = models.ForeignKey(Recipe, on_delete=models.CASCADE, related_name='cooked_dishes')
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return f"{self.user.username} - {self.recipe.recipe_name} ({self.created_at.strftime('%Y-%m-%d')})"
    
    class Meta:
        ordering = ['-created_at']

class IngredientCache(models.Model):
    """é£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¢ãƒ‡ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰"""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='ingredient_cache')
    ingredient_name = models.CharField(max_length=100)
    amount = models.DecimalField(max_digits=10, decimal_places=1)
    unit = models.CharField(max_length=20)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        unique_together = ['user', 'ingredient_name']
        ordering = ['ingredient_name']
    
    def __str__(self):
        return f"{self.ingredient_name} - {self.amount}{self.unit} ({self.user.username})"

class ApiKey(models.Model):
    """API Keyãƒ¢ãƒ‡ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰"""
    key_name = models.CharField(max_length=100)
    api_key = models.CharField(max_length=255, unique=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField(null=True, blank=True)
    last_used_at = models.DateTimeField(null=True, blank=True)
    usage_count = models.IntegerField(default=0)
    
    def __str__(self):
        return self.key_name
    
    class Meta:
        ordering = ['-created_at']
```

## ğŸ†• **3. LINEé€£æºæ©Ÿèƒ½å®Ÿè£…**

### 3.1 ãƒ†ã‚­ã‚¹ãƒˆè§£æã‚µãƒ¼ãƒ“ã‚¹

```python
# daily_dish/services/line_parser.py
import re
from typing import Dict, List, Tuple, Any
from django.core.exceptions import ValidationError

class LineTextParser:
    """LINEãƒ†ã‚­ã‚¹ãƒˆè§£æã‚µãƒ¼ãƒ“ã‚¹"""
    
    @staticmethod
    def classify_text_type(text: str) -> str:
        """ãƒ†ã‚­ã‚¹ãƒˆã®ç¨®é¡ã‚’åˆ¤å®š"""
        text = text.strip()
        
        # ãƒ‘ã‚¿ãƒ¼ãƒ³1: URLï¼ˆæ—¢å­˜ãƒ¬ã‚·ãƒ”ï¼‰
        if text.startswith(("http://", "https://")):
            return "url"
        
        # ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘
        if text == "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘":
            return "user_linking"
        
        # ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ–°è¦ãƒ¬ã‚·ãƒ”
        if ("ãƒ¬ã‚·ãƒ”:" in text and "ææ–™:" in text and "é‡:" in text):
            return "recipe"
        
        # ãƒ‘ã‚¿ãƒ¼ãƒ³4: ä¸æ˜
        return "invalid"
    
    @staticmethod
    def parse_recipe_text(text: str) -> Dict[str, Any]:
        """æ–°è¦ãƒ¬ã‚·ãƒ”ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æ"""
        lines = text.strip().split('\n')
        
        recipe_name = None
        ingredients = []
        amounts = []
        
        for line in lines:
            line = line.strip()
            if line.startswith("ãƒ¬ã‚·ãƒ”:"):
                recipe_name = line[3:].strip()
            elif line.startswith("ææ–™:"):
                ingredients_str = line[3:].strip()
                ingredients = [ing.strip() for ing in ingredients_str.split("ã€") if ing.strip()]
            elif line.startswith("é‡:"):
                amounts_str = line[2:].strip()
                amounts = [amt.strip() for amt in amounts_str.split("ã€") if amt.strip()]
        
        # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if not recipe_name:
            raise ValidationError("ãƒ¬ã‚·ãƒ”åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        if not ingredients:
            raise ValidationError("ææ–™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        if not amounts:
            raise ValidationError("é‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        if len(ingredients) != len(amounts):
            raise ValidationError(f"ææ–™æ•°({len(ingredients)})ã¨é‡ã®æ•°({len(amounts)})ãŒä¸€è‡´ã—ã¾ã›ã‚“")
        if len(ingredients) > 20:
            raise ValidationError("ææ–™ã¯æœ€å¤§20å€‹ã¾ã§ã§ã™")
        
        return {
            "recipe_name": recipe_name,
            "ingredients": ingredients,
            "amounts": amounts
        }
    
    @staticmethod
    def parse_amount_and_unit(amount_str: str) -> Tuple[float, str]:
        """é‡æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã¨å˜ä½ã‚’åˆ†é›¢"""
        # ä¾‹: "300g" â†’ (300.0, "g"), "1ç®±" â†’ (1.0, "ç®±")
        
        # æ•°å€¤ + å˜ä½ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
        match = re.match(r'^(\d+(?:\.\d+)?)\s*(.*)$', amount_str.strip())
        
        if match:
            amount = float(match.group(1))
            unit = match.group(2).strip() or "å€‹"
            return amount, unit
        else:
            # æ•°å€¤ãŒæŠ½å‡ºã§ããªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            return 1.0, amount_str.strip() or "å€‹"
    
    @classmethod
    def create_recipe_data(cls, recipe_name: str, ingredients: List[str], amounts: List[str]) -> Dict[str, Any]:
        """è§£æçµæœã‚’Recipeãƒ¢ãƒ‡ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›"""
        recipe_data = {
            "recipe_name": recipe_name,
            "recipe_url": None  # æ–°è¦ãƒ¬ã‚·ãƒ”
        }
        
        # ææ–™æƒ…å ±ã‚’DBãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        ingredients_data = []
        for i, (ingredient, amount_str) in enumerate(zip(ingredients, amounts)):
            if i >= 20:  # æœ€å¤§20å€‹ã¾ã§
                break
            
            amount_value, unit = cls.parse_amount_and_unit(amount_str)
            
            # DBãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å½¢å¼
            recipe_data[f'ingredient_{i+1}'] = ingredient
            recipe_data[f'amount_{i+1}'] = amount_value
            recipe_data[f'unit_{i+1}'] = unit
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨
            ingredients_data.append({
                'name': ingredient,
                'amount': amount_value,
                'unit': unit
            })
        
        recipe_data['ingredients_data'] = ingredients_data
        return recipe_data
```

### 3.2 LINE API ãƒ“ãƒ¥ãƒ¼

```python
# daily_dish/views_line.py
import json
import logging
from django.http import JsonResponse, HttpResponse
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_http_methods
from django.utils.decorators import method_decorator
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny
from rest_framework.response import Response
from rest_framework import status

from .models import User, Recipe
from .services.line_parser import LineTextParser
from .authentication import ApiKeyAuthentication
from .permissions import IsApiKeyAuthenticated

logger = logging.getLogger(__name__)

@api_view(['POST'])
@permission_classes([IsApiKeyAuthenticated])
def link_line_user(request):
    """LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘API"""
    try:
        line_user_id = request.data.get('line_user_id')
        app_user_id = request.data.get('app_user_id')
        
        # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if not line_user_id or not app_user_id:
            return Response({
                'status': 'error',
                'error_code': 'MISSING_PARAMETERS',
                'message': 'line_user_idã¨app_user_idãŒå¿…è¦ã§ã™'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ç¢ºèª
        try:
            user = User.objects.get(id=app_user_id)
        except User.DoesNotExist:
            return Response({
                'status': 'error',
                'error_code': 'USER_NOT_FOUND',
                'message': 'æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
            }, status=status.HTTP_404_NOT_FOUND)
        
        # æ—¢å­˜é€£æºãƒã‚§ãƒƒã‚¯
        if user.line_user_id:
            return Response({
                'status': 'error',
                'error_code': 'ALREADY_LINKED',
                'message': 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«ä»–ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é€£æºæ¸ˆã¿ã§ã™'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # LINEé‡è¤‡ãƒã‚§ãƒƒã‚¯
        if User.objects.filter(line_user_id=line_user_id).exists():
            return Response({
                'status': 'error',
                'error_code': 'LINE_ALREADY_USED',
                'message': 'ã“ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨é€£æºæ¸ˆã¿ã§ã™'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # ç´ã¥ã‘å®Ÿè¡Œ
        user.line_user_id = line_user_id
        user.save()
        
        return Response({
            'status': 'success',
            'message': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘ãŒå®Œäº†ã—ã¾ã—ãŸ',
            'user': {
                'id': user.id,
                'username': user.username,
                'line_user_id': user.line_user_id
            }
        }, status=status.HTTP_200_OK)
        
    except Exception as e:
        logger.error(f"LINE user linking error: {str(e)}")
        return Response({
            'status': 'error',
            'error_code': 'INTERNAL_ERROR',
            'message': 'å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@api_view(['POST'])
@permission_classes([IsApiKeyAuthenticated])
def register_recipe_from_line(request):
    """LINEãƒ¬ã‚·ãƒ”ç™»éŒ²API"""
    try:
        line_user_id = request.data.get('line_user_id')
        text = request.data.get('text')
        
        # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if not line_user_id or not text:
            return Response({
                'status': 'error',
                'error_code': 'MISSING_PARAMETERS',
                'message': 'line_user_idã¨textãŒå¿…è¦ã§ã™'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
        try:
            user = User.objects.get(line_user_id=line_user_id)
        except User.DoesNotExist:
            return Response({
                'status': 'error',
                'error_code': 'USER_NOT_LINKED',
                'message': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå½“ã‚¢ãƒ—ãƒªã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚'
            }, status=status.HTTP_404_NOT_FOUND)
        
        # ãƒ†ã‚­ã‚¹ãƒˆè§£æ
        parser = LineTextParser()
        text_type = parser.classify_text_type(text)
        
        if text_type == "user_linking":
            return Response({
                'status': 'info',
                'message': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘ã¯åˆ¥ã®APIã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        elif text_type == "recipe":
            # æ–°è¦ãƒ¬ã‚·ãƒ”ç™»éŒ²
            try:
                parsed_data = parser.parse_recipe_text(text)
                recipe_data = parser.create_recipe_data(
                    parsed_data['recipe_name'],
                    parsed_data['ingredients'],
                    parsed_data['amounts']
                )
                
                # ãƒ¬ã‚·ãƒ”ä½œæˆ
                ingredients_data = recipe_data.pop('ingredients_data')
                recipe_data['user'] = user
                
                recipe = Recipe.objects.create(**recipe_data)
                
                return Response({
                    'status': 'success',
                    'message': 'ãƒ¬ã‚·ãƒ”ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸ',
                    'recipe': {
                        'id': recipe.id,
                        'recipe_name': recipe.recipe_name,
                        'recipe_url': recipe.recipe_url,
                        'ingredients': ingredients_data,
                        'created_at': recipe.created_at.isoformat()
                    }
                }, status=status.HTTP_201_CREATED)
                
            except Exception as e:
                return Response({
                    'status': 'error',
                    'error_code': 'PARSE_ERROR',
                    'message': f'ãƒ†ã‚­ã‚¹ãƒˆã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}'
                }, status=status.HTTP_400_BAD_REQUEST)
        
        elif text_type == "url":
            # æ—¢å­˜ãƒ¬ã‚·ãƒ”ç™»éŒ²ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
            return Response({
                'status': 'error',
                'error_code': 'NOT_IMPLEMENTED',
                'message': 'URLè§£ææ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™'
            }, status=status.HTTP_501_NOT_IMPLEMENTED)
        
        else:
            # ä¸æ˜ãªå½¢å¼
            return Response({
                'status': 'error',
                'error_code': 'INVALID_FORMAT',
                'message': 'èªè­˜ã§ããªã„å½¢å¼ã§ã™ã€‚\n\nåˆ©ç”¨å¯èƒ½ãªå½¢å¼:\n- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘\n- ãƒ¬ã‚·ãƒ”:â—‹â—‹\nææ–™:ææ–™1ã€ææ–™2\né‡:é‡1ã€é‡2'
            }, status=status.HTTP_400_BAD_REQUEST)
        
    except Exception as e:
        logger.error(f"LINE recipe registration error: {str(e)}")
        return Response({
            'status': 'error',
            'error_code': 'INTERNAL_ERROR',
            'message': 'å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

# LINE Bot Webhookï¼ˆå°†æ¥å®Ÿè£…ï¼‰
@csrf_exempt
@require_http_methods(["POST"])
def line_webhook(request):
    """LINE Bot Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ"""
    # LINE Bot APIç½²åæ¤œè¨¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè£…
    # ç¾åœ¨ã¯ç°¡æ˜“ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    return HttpResponse("OK", status=200)
```

### 3.3 URLè¨­å®šè¿½åŠ 

```python
# daily_dish/urls.py ã«è¿½åŠ 

from django.urls import path, include
from . import views_line

# LINEé€£æºç”¨URLè¿½åŠ 
line_patterns = [
    path('users/link-line/', views_line.link_line_user, name='link_line_user'),
    path('recipes/from-line/', views_line.register_recipe_from_line, name='register_recipe_from_line'),
    path('line/webhook/', views_line.line_webhook, name='line_webhook'),
]

urlpatterns = [
    # æ—¢å­˜ã®URL...
    path('api/external/', include(line_patterns)),
]
```

## 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ 

### 4.1 LINEé–¢é€£è¨­å®š

```python
# daily_dish_project/settings.py ã«è¿½åŠ 

# LINE Bot APIè¨­å®š
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET', '')
LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN', '')

# å¤–éƒ¨URLè§£æAPIè¨­å®šï¼ˆå°†æ¥å®Ÿè£…ï¼‰
RECIPE_PARSER_API_URL = os.environ.get('RECIPE_PARSER_API_URL', '')
RECIPE_PARSER_API_KEY = os.environ.get('RECIPE_PARSER_API_KEY', '')

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆRedisè¨­å®šä¾‹ï¼‰
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': os.environ.get('REDIS_URL', 'redis://127.0.0.1:6379/1'),
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

# ãƒ­ã‚°è¨­å®šè¿½åŠ 
LOGGING['loggers']['daily_dish.views_line'] = {
    'handlers': ['file', 'console'],
    'level': 'INFO',
    'propagate': False,
}
```

### 4.2 ç’°å¢ƒå¤‰æ•°è¨­å®šä¾‹

```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«ä¾‹
LINE_CHANNEL_SECRET=your_line_channel_secret_here
LINE_CHANNEL_ACCESS_TOKEN=your_line_access_token_here
RECIPE_PARSER_API_URL=https://your-recipe-parser-api.com/api/parse
RECIPE_PARSER_API_KEY=your_recipe_parser_api_key_here
REDIS_URL=redis://localhost:6379/1
```

## 5. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹

### 5.1 LINEé€£æºæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

```python
# daily_dish/tests_line.py
from django.test import TestCase
from django.urls import reverse
from rest_framework.test import APITestCase
from rest_framework import status
from .models import User, Recipe, ApiKey
from .services.line_parser import LineTextParser

class LineTextParserTest(TestCase):
    """LINEãƒ†ã‚­ã‚¹ãƒˆè§£æãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        self.parser = LineTextParser()
    
    def test_classify_text_type(self):
        """ãƒ†ã‚­ã‚¹ãƒˆåˆ†é¡ãƒ†ã‚¹ãƒˆ"""
        # URL
        self.assertEqual(self.parser.classify_text_type("https://cookpad.com/recipe/123"), "url")
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘
        self.assertEqual(self.parser.classify_text_type("ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘"), "user_linking")
        
        # æ–°è¦ãƒ¬ã‚·ãƒ”
        recipe_text = "ãƒ¬ã‚·ãƒ”:ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼\nææ–™:é¶è‚‰ã€ç‰ã­ã\né‡:300gã€200g"
        self.assertEqual(self.parser.classify_text_type(recipe_text), "recipe")
        
        # ä¸æ˜
        self.assertEqual(self.parser.classify_text_type("hello world"), "invalid")
    
    def test_parse_recipe_text(self):
        """ãƒ¬ã‚·ãƒ”ãƒ†ã‚­ã‚¹ãƒˆè§£æãƒ†ã‚¹ãƒˆ"""
        text = "ãƒ¬ã‚·ãƒ”:ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼\nææ–™:é¶è‚‰ã€ç‰ã­ãã€ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼\né‡:300gã€200gã€1ç®±"
        
        result = self.parser.parse_recipe_text(text)
        
        self.assertEqual(result['recipe_name'], 'ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼')
        self.assertEqual(result['ingredients'], ['é¶è‚‰', 'ç‰ã­ã', 'ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼'])
        self.assertEqual(result['amounts'], ['300g', '200g', '1ç®±'])
    
    def test_parse_amount_and_unit(self):
        """é‡ãƒ»å˜ä½è§£æãƒ†ã‚¹ãƒˆ"""
        # æ­£å¸¸ã‚±ãƒ¼ã‚¹
        amount, unit = self.parser.parse_amount_and_unit("300g")
        self.assertEqual(amount, 300.0)
        self.assertEqual(unit, "g")
        
        # å˜ä½ãªã—
        amount, unit = self.parser.parse_amount_and_unit("2")
        self.assertEqual(amount, 2.0)
        self.assertEqual(unit, "å€‹")

class LineAPITest(APITestCase):
    """LINE API ãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123'
        )
        self.api_key = ApiKey.objects.create(
            key_name='test_key',
            api_key='test_api_key_12345'
        )
    
    def test_link_line_user_success(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘æˆåŠŸãƒ†ã‚¹ãƒˆ"""
        url = reverse('link_line_user')
        data = {
            'line_user_id': 'U1234567890abcdef1234567890abcdef',
            'app_user_id': str(self.user.id)
        }
        
        response = self.client.post(
            url, 
            data, 
            HTTP_X_API_KEY='test_api_key_12345'
        )
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data['status'], 'success')
        
        # DBã®ç¢ºèª
        self.user.refresh_from_db()
        self.assertEqual(self.user.line_user_id, 'U1234567890abcdef1234567890abcdef')
    
    def test_register_recipe_from_line_success(self):
        """LINEãƒ¬ã‚·ãƒ”ç™»éŒ²æˆåŠŸãƒ†ã‚¹ãƒˆ"""
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«LINE IDè¨­å®š
        self.user.line_user_id = 'U1234567890abcdef1234567890abcdef'
        self.user.save()
        
        url = reverse('register_recipe_from_line')
        data = {
            'line_user_id': 'U1234567890abcdef1234567890abcdef',
            'text': 'ãƒ¬ã‚·ãƒ”:ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼\nææ–™:é¶è‚‰ã€ç‰ã­ã\né‡:300gã€200g'
        }
        
        response = self.client.post(
            url, 
            data, 
            HTTP_X_API_KEY='test_api_key_12345'
        )
        
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(response.data['status'], 'success')
        
        # DBã®ç¢ºèª
        recipe = Recipe.objects.get(recipe_name='ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼')
        self.assertEqual(recipe.user, self.user)
        self.assertEqual(recipe.ingredient_1, 'é¶è‚‰')
        self.assertEqual(recipe.amount_1, 300.0)
        self.assertEqual(recipe.unit_1, 'g')
```

## ğŸ†• **6. v3ã§ã®ä¸»è¦å¤‰æ›´ç‚¹ã¾ã¨ã‚**

### 6.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´
- **users ãƒ†ãƒ¼ãƒ–ãƒ«**: `line_user_id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: v2â†’v3ã®æ®µéšçš„ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: LINEé€£æºç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 

### 6.2 ã‚³ãƒ¼ãƒ‰è¿½åŠ 
- **models.py**: User ãƒ¢ãƒ‡ãƒ«ã«LINEé€£æºæ©Ÿèƒ½è¿½åŠ 
- **services/line_parser.py**: ãƒ†ã‚­ã‚¹ãƒˆè§£æã‚µãƒ¼ãƒ“ã‚¹æ–°è¦ä½œæˆ
- **views_line.py**: LINEé€£æºAPIæ–°è¦ä½œæˆ
- **tests_line.py**: LINEæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆæ–°è¦ä½œæˆ

### 6.3 APIè¿½åŠ 
- **POST /api/external/users/link-line/**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘
- **POST /api/external/recipes/from-line/**: LINEãƒ¬ã‚·ãƒ”ç™»éŒ²
- **POST /api/external/line/webhook/**: LINE Webhookï¼ˆå°†æ¥å®Ÿè£…ï¼‰

### 6.4 è¨­å®šè¿½åŠ 
- **settings.py**: LINE Bot APIè¨­å®šè¿½åŠ 
- **.env**: ç’°å¢ƒå¤‰æ•°è¨­å®šä¾‹
- **urls.py**: LINEç”¨URLè¿½åŠ 

### 6.5 æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿
- **Webã‚¢ãƒ—ãƒª**: æ—¢å­˜æ©Ÿèƒ½ã¯å¤‰æ›´ãªã—
- **æ—¢å­˜API**: å‹•ä½œã«å½±éŸ¿ãªã—
- **ãƒ‡ãƒ¼ã‚¿**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã€æ–°æ©Ÿèƒ½ã®ã¿è¿½åŠ 

---

**æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­è¨ˆæ›¸ï¼ˆv3ï¼‰ã¯LINEé€£æºæ©Ÿèƒ½ã®å®Ÿè£…ãƒ¬ãƒ™ãƒ«ã§ã®è©³ç´°ä»•æ§˜ã‚’å®šç¾©ã—ã€å®Ÿè£…ã«å¿…è¦ãªå…¨ã‚³ãƒ¼ãƒ‰ã‚’æä¾›ã™ã‚‹**

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u65e2\u5b58\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u8cc7\u6599\u3092old\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5", "status": "completed", "priority": "high", "id": "move_old_docs"}, {"content": "\u4f01\u753b\u66f8_v3.md\u306e\u4f5c\u6210\uff08LINE\u9023\u643a\u6a5f\u80fd\u8ffd\u52a0\uff09", "status": "completed", "priority": "high", "id": "create_v3_planning"}, {"content": "\u57fa\u672c\u8a2d\u8a08\u66f8_v3.md\u306e\u4f5c\u6210", "status": "completed", "priority": "high", "id": "create_v3_basic_design"}, {"content": "\u8a73\u7d30\u8a2d\u8a08\u66f8_v3.md\u306e\u4f5c\u6210", "status": "completed", "priority": "high", "id": "create_v3_detailed_design"}, {"content": "\u30d7\u30ed\u30b0\u30e9\u30e0\u8a2d\u8a08\u66f8_v3.md\u306e\u4f5c\u6210", "status": "completed", "priority": "high", "id": "create_v3_program_design"}]