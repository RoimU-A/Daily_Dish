# Daily Dish è©³ç´°è¨­è¨ˆæ›¸ï¼ˆv3ï¼‰

## 1. è¨­è¨ˆæ¦‚è¦

### 1.1 å¯¾è±¡ç¯„å›²
æœ¬è©³ç´°è¨­è¨ˆæ›¸ã¯çµ±ä¸€ã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆv3ï¼‰ã«LINEé€£æºæ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸå®Ÿè£…ã«å¿…è¦ãªè©³ç´°ä»•æ§˜ã‚’å®šç¾©ã™ã‚‹ï¼š
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆLINEé€£æºå¯¾å¿œï¼‰
- APIä»•æ§˜å®šç¾©ï¼ˆLINEé€£æºAPIè¿½åŠ ï¼‰
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»•æ§˜ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè§£æå¯¾å¿œï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»•æ§˜ï¼ˆLINEç‰¹æœ‰ã‚¨ãƒ©ãƒ¼å¯¾å¿œï¼‰
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ä»•æ§˜ï¼ˆãƒãƒ«ãƒãƒãƒ£ãƒãƒ«å¯¾å¿œï¼‰

### 1.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Djangoï¼ˆPythonï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLiteï¼ˆé–‹ç™ºï¼‰/ SQL Serverï¼ˆæœ¬ç•ªï¼‰
- **èªè¨¼**: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼ˆAPI Key + JWTï¼‰
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React + TypeScript
- **ğŸ†• å¤–éƒ¨é€£æº**: LINE Bot API

## ğŸ†• **2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°è¨­è¨ˆï¼ˆv3å¤‰æ›´ï¼‰**

### 2.1 ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆ

#### 2.1.1 ğŸ†• usersãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆLINEé€£æºå¯¾å¿œï¼‰
**ç”¨é€”**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç®¡ç†ï¼ˆLINEé€£æºå«ã‚€ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| username | VARCHAR(150) | NOT NULL, UNIQUE | ãƒ¦ãƒ¼ã‚¶ãƒ¼å |
| email | VARCHAR(254) | NOT NULL, UNIQUE | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| password | VARCHAR(128) | NOT NULL | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ |
| **line_user_id** | **VARCHAR(100)** | **UNIQUE, NULL** | **ğŸ†• LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ID** |
| first_name | VARCHAR(150) | NULL | åå‰ |
| last_name | VARCHAR(150) | NULL | å§“ |
| is_active | BOOLEAN | DEFAULT TRUE | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ©ã‚° |
| is_staff | BOOLEAN | DEFAULT FALSE | ã‚¹ã‚¿ãƒƒãƒ•ãƒ•ãƒ©ã‚° |
| is_superuser | BOOLEAN | DEFAULT FALSE | ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ©ã‚° |
| date_joined | DATETIME | DEFAULT NOW() | å‚åŠ æ—¥æ™‚ |
| created_at | DATETIME | DEFAULT NOW() | ä½œæˆæ—¥æ™‚ |
| updated_at | DATETIME | DEFAULT NOW() | æ›´æ–°æ—¥æ™‚ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: username, email, line_user_id  
**ğŸ†• å¤‰æ›´ç‚¹**:
- **line_user_id ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ **: LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºç”¨
- **UNIQUEåˆ¶ç´„**: 1ã¤ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯1ã¤ã®ã‚¢ãƒ—ãƒªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
- **NULLè¨±å¯**: æœªé€£æºãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾å¿œ

#### 2.1.2 recipesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰
**ç”¨é€”**: å…¨ãƒ¬ã‚·ãƒ”ï¼ˆæ—¢å­˜ãƒ»æ–°è¦ï¼‰ã®çµ±ä¸€ç®¡ç†

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | ãƒ¬ã‚·ãƒ”ID |
| user_id | BIGINT | NOT NULL, FK | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| recipe_name | VARCHAR(255) | NOT NULL | ãƒ¬ã‚·ãƒ”å |
| recipe_url | VARCHAR(500) | NULL | ãƒ¬ã‚·ãƒ”URLï¼ˆæ—¢å­˜ãƒ¬ã‚·ãƒ”ç”¨ï¼‰ |
| ingredient_1ï½20 | VARCHAR(100) | NULL | ææ–™åï¼ˆ1ï½20ï¼‰ |
| amount_1ï½20 | DECIMAL(10,1) | NULL | åˆ†é‡ï¼ˆ1ï½20ï¼‰ |
| unit_1ï½20 | VARCHAR(20) | NULL | å˜ä½ï¼ˆ1ï½20ï¼‰ |
| created_at | DATETIME | DEFAULT NOW() | ä½œæˆæ—¥æ™‚ |
| updated_at | DATETIME | DEFAULT NOW() | æ›´æ–°æ—¥æ™‚ |

**å¤–éƒ¨ã‚­ãƒ¼**: user_id â†’ users.id (CASCADE)  
**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: user_id, created_at

**âœ… v3å¯¾å¿œ**:
- **æ—¢å­˜æ§‹é€ ç¶­æŒ**: LINEã‹ã‚‰ã®å…¥åŠ›ã‚‚åŒä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ§‹é€ ã§å¯¾å¿œ
- **Web + LINE**: ä¸¡æ–¹ã®å…¥åŠ›çµŒè·¯ã‹ã‚‰åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²

#### 2.1.3 cooked_dishesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰
**ç”¨é€”**: æ–™ç†å±¥æ­´ç®¡ç†

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | æ–™ç†å±¥æ­´ID |
| user_id | BIGINT | NOT NULL, FK | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| recipe_id | BIGINT | NOT NULL, FK | ãƒ¬ã‚·ãƒ”ID |
| created_at | DATETIME | DEFAULT NOW() | æ–™ç†æ—¥æ™‚ |

**å¤–éƒ¨ã‚­ãƒ¼**: 
- user_id â†’ users.id (CASCADE)
- recipe_id â†’ recipes.id (CASCADE)

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: user_id, recipe_id, created_at

#### 2.1.4 ingredient_cacheãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰
**ç”¨é€”**: é£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ID |
| user_id | BIGINT | NOT NULL, FK | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| ingredient_name | VARCHAR(100) | NOT NULL | ææ–™å |
| amount | DECIMAL(10,1) | NOT NULL | åˆ†é‡ |
| unit | VARCHAR(20) | NOT NULL | å˜ä½ |
| created_at | DATETIME | DEFAULT NOW() | ä½œæˆæ—¥æ™‚ |

**å¤–éƒ¨ã‚­ãƒ¼**: user_id â†’ users.id (CASCADE)  
**ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„**: (user_id, ingredient_name)  
**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: user_id

#### 2.1.5 api_keysãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰
**ç”¨é€”**: API Keyç®¡ç†

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | API Key ID |
| key_name | VARCHAR(100) | NOT NULL | API Keyå |
| api_key | VARCHAR(255) | NOT NULL, UNIQUE | API Key |
| is_active | BOOLEAN | DEFAULT TRUE | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ©ã‚° |
| created_at | DATETIME | DEFAULT NOW() | ä½œæˆæ—¥æ™‚ |
| expires_at | DATETIME | NULL | æœ‰åŠ¹æœŸé™ |
| last_used_at | DATETIME | NULL | æœ€çµ‚ä½¿ç”¨æ—¥æ™‚ |
| usage_count | INT | DEFAULT 0 | ä½¿ç”¨å›æ•° |

**ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„**: api_key  
**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: api_key, is_active

### 2.2 ãƒ‡ãƒ¼ã‚¿ç®¡ç†ä»•æ§˜

#### 2.2.1 LINEé€£æºãƒ‡ãƒ¼ã‚¿ç®¡ç†
**LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘**:
- `line_user_id`: LINEãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
- **æœªé€£æºçŠ¶æ…‹**: `line_user_id = NULL`
- **é€£æºæ¸ˆã¿çŠ¶æ…‹**: `line_user_id = 'U1234567890abcdef...'`
- **ä¸€æ„åˆ¶ç´„**: 1ã¤ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯1ã¤ã®ã‚¢ãƒ—ãƒªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿

#### 2.2.2 ãƒãƒ«ãƒãƒãƒ£ãƒãƒ« ãƒ¬ã‚·ãƒ”ç®¡ç†
**Webã‚¢ãƒ—ãƒªã‹ã‚‰ã®ç™»éŒ²**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼: JWTèªè¨¼ã§è­˜åˆ¥
- å…¥åŠ›: ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼
- ãƒ‡ãƒ¼ã‚¿: ç›´æ¥DBãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜

**LINEã‹ã‚‰ã®ç™»éŒ²**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼: `line_user_id`ã§è­˜åˆ¥ â†’ `user_id`å–å¾—
- å…¥åŠ›: ãƒ†ã‚­ã‚¹ãƒˆè§£æ
- ãƒ‡ãƒ¼ã‚¿: è§£æçµæœã‚’DBãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒãƒƒãƒ”ãƒ³ã‚°

#### 2.2.3 ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ï¼ˆæ‹¡å¼µï¼‰
1. **ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã«å…¨é–¢é€£ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
2. **ãƒ¬ã‚·ãƒ”ä¿è­·**: æ–™ç†å±¥æ­´ã§ä½¿ç”¨ä¸­ã®ãƒ¬ã‚·ãƒ”ã¯å‰Šé™¤ä¸å¯
3. **ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã®é£Ÿæã‚­ãƒ£ãƒƒã‚·ãƒ¥åé‡è¤‡ä¸å¯
4. **ğŸ†• LINEé€£æºåˆ¶ç´„**: 1ã¤ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯1ã¤ã®ã‚¢ãƒ—ãƒªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿

## ğŸ†• **3. LINEé€£æºAPIè©³ç´°è¨­è¨ˆ**

### 3.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘API

#### 3.1.1 LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/external/users/link-line/`  
**èªè¨¼**: API Key

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä»•æ§˜**:
```json
{
  "line_user_id": "U1234567890abcdef1234567890abcdef",
  "app_user_id": "123"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä»•æ§˜**:
```json
// æˆåŠŸ
{
  "status": "success",
  "message": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘ãŒå®Œäº†ã—ã¾ã—ãŸ",
  "user": {
    "id": 123,
    "username": "testuser",
    "line_user_id": "U1234567890abcdef1234567890abcdef"
  }
}

// ã‚¨ãƒ©ãƒ¼
{
  "status": "error",
  "error_code": "USER_NOT_FOUND",
  "message": "æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
}
```

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**:
- `line_user_id`: å¿…é ˆã€æ–‡å­—åˆ—ã€æœ€å¤§100æ–‡å­—ã€LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDå½¢å¼
- `app_user_id`: å¿…é ˆã€æ•°å€¤ã€å­˜åœ¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

**ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹**:
- `USER_NOT_FOUND`: æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå­˜åœ¨ã—ãªã„
- `ALREADY_LINKED`: æ—¢ã«ä»–ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é€£æºæ¸ˆã¿
- `LINE_ALREADY_USED`: æŒ‡å®šLINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨é€£æºæ¸ˆã¿

### 3.2 LINEãƒ¬ã‚·ãƒ”ç™»éŒ²API

#### 3.2.1 LINE ãƒ¬ã‚·ãƒ”ç™»éŒ²
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/external/recipes/from-line/`  
**èªè¨¼**: API Key

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä»•æ§˜**:
```json
{
  "line_user_id": "U1234567890abcdef1234567890abcdef",
  "text": "ãƒ¬ã‚·ãƒ”:ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼\nææ–™:é¶è‚‰ã€ç‰ã­ãã€ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼\né‡:300gã€200gã€1ç®±"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä»•æ§˜**:
```json
// æˆåŠŸï¼ˆæ–°è¦ãƒ¬ã‚·ãƒ”ï¼‰
{
  "status": "success",
  "message": "ãƒ¬ã‚·ãƒ”ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸ",
  "recipe": {
    "id": 456,
    "recipe_name": "ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼",
    "recipe_url": null,
    "ingredients": [
      {"name": "é¶è‚‰", "amount": 300.0, "unit": "g"},
      {"name": "ç‰ã­ã", "amount": 200.0, "unit": "g"},
      {"name": "ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼", "amount": 1.0, "unit": "ç®±"}
    ],
    "created_at": "2025-07-12T10:30:00Z"
  }
}

// æˆåŠŸï¼ˆæ—¢å­˜ãƒ¬ã‚·ãƒ”ãƒ»å°†æ¥å®Ÿè£…ï¼‰
{
  "status": "success",
  "message": "ãƒ¬ã‚·ãƒ”ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸ",
  "recipe": {
    "id": 457,
    "recipe_name": "ã‚¯ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã®ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼",
    "recipe_url": "https://cookpad.com/recipe/123456",
    "ingredients": [...],
    "created_at": "2025-07-12T10:35:00Z"
  }
}

// ã‚¨ãƒ©ãƒ¼
{
  "status": "error",
  "error_code": "USER_NOT_LINKED",
  "message": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå½“ã‚¢ãƒ—ãƒªã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
}
```

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**:
- `line_user_id`: å¿…é ˆã€æ–‡å­—åˆ—ã€æœ€å¤§100æ–‡å­—ã€é€£æºæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
- `text`: å¿…é ˆã€æ–‡å­—åˆ—ã€æœ€å¤§2000æ–‡å­—

**ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹**:
- `USER_NOT_LINKED`: LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æœªé€£æº
- `INVALID_FORMAT`: ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ãŒèªè­˜ã§ããªã„
- `PARSE_ERROR`: ãƒ†ã‚­ã‚¹ãƒˆè§£æã«å¤±æ•—
- `EXTERNAL_API_ERROR`: å¤–éƒ¨URLè§£æAPIå‘¼ã³å‡ºã—å¤±æ•—ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

### 3.3 ãƒ†ã‚­ã‚¹ãƒˆè§£æä»•æ§˜

#### 3.3.1 è§£æãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†é¡
```python
def classify_text_type(text):
    """ãƒ†ã‚­ã‚¹ãƒˆã®ç¨®é¡ã‚’åˆ¤å®š"""
    text = text.strip()
    
    # ãƒ‘ã‚¿ãƒ¼ãƒ³1: URLï¼ˆæ—¢å­˜ãƒ¬ã‚·ãƒ”ï¼‰
    if text.startswith(("http://", "https://")):
        return "url"
    
    # ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘
    if text == "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘":
        return "user_linking"
    
    # ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ–°è¦ãƒ¬ã‚·ãƒ”
    if ("ãƒ¬ã‚·ãƒ”:" in text and "ææ–™:" in text and "é‡:" in text):
        return "recipe"
    
    # ãƒ‘ã‚¿ãƒ¼ãƒ³4: ä¸æ˜
    return "invalid"
```

#### 3.3.2 æ–°è¦ãƒ¬ã‚·ãƒ”è§£æä»•æ§˜
```python
def parse_recipe_text(text):
    """æ–°è¦ãƒ¬ã‚·ãƒ”ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æ"""
    lines = text.strip().split('\n')
    
    # å„è¡Œã‚’è§£æ
    recipe_name = None
    ingredients = []
    amounts = []
    
    for line in lines:
        if line.startswith("ãƒ¬ã‚·ãƒ”:"):
            recipe_name = line[3:].strip()  # "ãƒ¬ã‚·ãƒ”:"ã‚’é™¤å»
        elif line.startswith("ææ–™:"):
            ingredients_str = line[3:].strip()  # "ææ–™:"ã‚’é™¤å»
            ingredients = [ing.strip() for ing in ingredients_str.split("ã€")]
        elif line.startswith("é‡:"):
            amounts_str = line[2:].strip()  # "é‡:"ã‚’é™¤å»
            amounts = [amt.strip() for amt in amounts_str.split("ã€")]
    
    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if not recipe_name:
        raise ValueError("ãƒ¬ã‚·ãƒ”åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    if not ingredients:
        raise ValueError("ææ–™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    if not amounts:
        raise ValueError("é‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    if len(ingredients) != len(amounts):
        raise ValueError("ææ–™ã¨é‡ã®å€‹æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“")
    
    return {
        "recipe_name": recipe_name,
        "ingredients": ingredients,
        "amounts": amounts
    }
```

#### 3.3.3 é‡ãƒ»å˜ä½è§£æä»•æ§˜
```python
import re

def parse_amount_and_unit(amount_str):
    """é‡æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã¨å˜ä½ã‚’åˆ†é›¢"""
    # ä¾‹: "300g" â†’ (300.0, "g"), "1ç®±" â†’ (1.0, "ç®±")
    
    # æ•°å€¤ + å˜ä½ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
    match = re.match(r'^(\d+(?:\.\d+)?)\s*(.*)$', amount_str.strip())
    
    if match:
        amount = float(match.group(1))
        unit = match.group(2).strip() or "å€‹"  # å˜ä½ãŒãªã„å ´åˆã¯"å€‹"
        return amount, unit
    else:
        # æ•°å€¤ãŒæŠ½å‡ºã§ããªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        return 1.0, amount_str.strip() or "å€‹"
```

#### 3.3.4 DBãƒãƒƒãƒ”ãƒ³ã‚°ä»•æ§˜
```python
def map_to_recipe_fields(recipe_name, ingredients, amounts):
    """è§£æçµæœã‚’DBãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å½¢å¼ã«ãƒãƒƒãƒ”ãƒ³ã‚°"""
    recipe_data = {
        "recipe_name": recipe_name,
        "recipe_url": None  # æ–°è¦ãƒ¬ã‚·ãƒ”
    }
    
    # æœ€å¤§20å€‹ã¾ã§
    for i, (ingredient, amount_str) in enumerate(zip(ingredients, amounts), 1):
        if i > 20:
            break
        
        amount_value, unit = parse_amount_and_unit(amount_str)
        
        recipe_data[f'ingredient_{i}'] = ingredient
        recipe_data[f'amount_{i}'] = amount_value
        recipe_data[f'unit_{i}'] = unit
    
    return recipe_data
```

## 4. æ—¢å­˜APIè©³ç´°è¨­è¨ˆï¼ˆå¤‰æ›´ãªã—ï¼‰

### 4.1 Web APIï¼ˆJWTèªè¨¼ï¼‰

#### 4.1.1 çµ±ä¸€ãƒ¬ã‚·ãƒ”ç®¡ç†API
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `/api/web/recipes/`

**POST - ãƒ¬ã‚·ãƒ”ä½œæˆ**
```json
Request:
{
  "recipe_name": "ã‚¯ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã®ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼",
  "recipe_url": "https://cookpad.com/recipe/123456",
  "ingredient_1": "é¶è‚‰",
  "amount_1": 300.0,
  "unit_1": "g",
  "ingredient_2": "ç‰ã­ã",
  "amount_2": 200.0,
  "unit_2": "g"
}

Response:
{
  "id": 123,
  "user": "username",
  "recipe_name": "ã‚¯ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã®ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼",
  "recipe_url": "https://cookpad.com/recipe/123456",
  "ingredients": [
    {"name": "é¶è‚‰", "amount": 300.0, "unit": "g"},
    {"name": "ç‰ã­ã", "amount": 200.0, "unit": "g"}
  ],
  "created_at": "2025-07-12T10:30:00Z",
  "updated_at": "2025-07-12T10:30:00Z"
}
```

## ğŸ†• **5. å¤–éƒ¨é€£æºè¨­è¨ˆ**

### 5.1 LINE Boté€£æº

#### 5.1.1 Webhookä»•æ§˜
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `/api/external/line/webhook/`  
**ãƒ¡ã‚½ãƒƒãƒ‰**: POST  
**èªè¨¼**: LINE Bot APIç½²åæ¤œè¨¼

**LINE Message Eventå‡¦ç†**:
```python
def handle_line_message(event):
    """LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†"""
    line_user_id = event.source.user_id
    text = event.message.text
    
    # ãƒ†ã‚­ã‚¹ãƒˆåˆ†é¡
    text_type = classify_text_type(text)
    
    if text_type == "user_linking":
        return handle_user_linking_request(line_user_id)
    elif text_type == "recipe":
        return handle_recipe_registration(line_user_id, text)
    elif text_type == "url":
        return handle_url_recipe_registration(line_user_id, text)  # å°†æ¥å®Ÿè£…
    else:
        return "èªè­˜ã§ããªã„å½¢å¼ã§ã™ã€‚\n\nåˆ©ç”¨å¯èƒ½ãªå½¢å¼:\n- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘\n- ãƒ¬ã‚·ãƒ”:â—‹â—‹\nææ–™:ææ–™1ã€ææ–™2\né‡:é‡1ã€é‡2"

def handle_user_linking_request(line_user_id):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†"""
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆRedisç­‰ã§å®Ÿè£…ï¼‰
    set_user_linking_state(line_user_id, True)
    return "å½“ã‚¢ãƒ—ãƒªã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚"

def handle_recipe_registration(line_user_id, text):
    """ãƒ¬ã‚·ãƒ”ç™»éŒ²å‡¦ç†"""
    try:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ç¢ºèª
        user = get_user_by_line_id(line_user_id)
        if not user:
            return "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå½“ã‚¢ãƒ—ãƒªã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
        
        # ãƒ†ã‚­ã‚¹ãƒˆè§£æ
        parsed = parse_recipe_text(text)
        
        # DBç™»éŒ²
        recipe_data = map_to_recipe_fields(
            parsed["recipe_name"],
            parsed["ingredients"],
            parsed["amounts"]
        )
        recipe_data["user_id"] = user.id
        
        recipe = Recipe.objects.create(**recipe_data)
        
        return f"ãƒ¬ã‚·ãƒ”ã€Œ{recipe.recipe_name}ã€ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼"
        
    except Exception as e:
        return f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
```

#### 5.1.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
```python
# Redisç­‰ã‚’ä½¿ç”¨ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
def set_user_linking_state(line_user_id, state):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘å¾…æ©ŸçŠ¶æ…‹ã‚’è¨­å®š"""
    redis_client.setex(f"linking:{line_user_id}", 300, "waiting")  # 5åˆ†é–“æœ‰åŠ¹

def is_waiting_for_user_id(line_user_id):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå…¥åŠ›å¾…æ©Ÿä¸­ã‹ãƒã‚§ãƒƒã‚¯"""
    return redis_client.exists(f"linking:{line_user_id}")

def clear_user_linking_state(line_user_id):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢"""
    redis_client.delete(f"linking:{line_user_id}")
```

### 5.2 å¤–éƒ¨URLè§£æAPIé€£æºï¼ˆå°†æ¥å®Ÿè£…ï¼‰

#### 5.2.1 APIå‘¼ã³å‡ºã—ä»•æ§˜
```python
import requests

def fetch_recipe_from_url(url):
    """å¤–éƒ¨APIã‹ã‚‰ãƒ¬ã‚·ãƒ”æƒ…å ±ã‚’å–å¾—"""
    try:
        response = requests.post(
            settings.RECIPE_PARSER_API_URL,
            json={"url": url},
            headers={
                "Authorization": f"Bearer {settings.RECIPE_PARSER_API_KEY}",
                "Content-Type": "application/json"
            },
            timeout=30
        )
        response.raise_for_status()
        
        data = response.json()
        return {
            "recipe_name": data["title"],
            "ingredients": data["ingredients"],  # [{"name": "...", "amount": "..."}]
            "amounts": [ing["amount"] for ing in data["ingredients"]]
        }
    except requests.RequestException as e:
        raise Exception(f"å¤–éƒ¨APIé€£æºã‚¨ãƒ©ãƒ¼: {str(e)}")
```

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»•æ§˜

### 6.1 LINE APIå›ºæœ‰ã‚¨ãƒ©ãƒ¼

#### 6.1.1 ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰å®šç¾©
| ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ | èª¬æ˜ | å¯¾å¿œ |
|-------------|------|------|
| USER_NOT_LINKED | LINEãƒ¦ãƒ¼ã‚¶ãƒ¼æœªé€£æº | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ¡ˆå†… |
| INVALID_FORMAT | ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ä¸æ­£ | å½¢å¼èª¬æ˜ |
| PARSE_ERROR | è§£æå¤±æ•— | å†å…¥åŠ›ä¾é ¼ |
| USER_NOT_FOUND | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDä¸å­˜åœ¨ | IDç¢ºèªä¾é ¼ |
| ALREADY_LINKED | æ—¢ã«é€£æºæ¸ˆã¿ | ç¾åœ¨ã®é€£æºçŠ¶æ³è¡¨ç¤º |
| LINE_ALREADY_USED | LINEé‡è¤‡ä½¿ç”¨ | ç®¡ç†è€…å•ã„åˆã‚ã›æ¡ˆå†… |

#### 6.1.2 ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
```python
ERROR_MESSAGES = {
    "USER_NOT_LINKED": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå½“ã‚¢ãƒ—ãƒªã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚",
    "INVALID_FORMAT": "èªè­˜ã§ããªã„å½¢å¼ã§ã™ã€‚\n\nåˆ©ç”¨å¯èƒ½ãªå½¢å¼:\n- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘\n- ãƒ¬ã‚·ãƒ”:â—‹â—‹\nææ–™:ææ–™1ã€ææ–™2\né‡:é‡1ã€é‡2",
    "PARSE_ERROR": "ãƒ†ã‚­ã‚¹ãƒˆã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦å†åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
    "USER_NOT_FOUND": "æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
    "ALREADY_LINKED": "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ—¢ã«é€£æºæ¸ˆã¿ã§ã™ã€‚",
    "LINE_ALREADY_USED": "ã“ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨é€£æºæ¸ˆã¿ã§ã™ã€‚"
}
```

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä»•æ§˜

### 7.1 LINE Bot ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### 7.1.1 ç½²åæ¤œè¨¼
```python
import hmac
import hashlib
import base64

def verify_line_signature(body, signature, channel_secret):
    """LINE Bot APIç½²åæ¤œè¨¼"""
    hash = hmac.new(
        channel_secret.encode('utf-8'),
        body.encode('utf-8'),
        hashlib.sha256
    ).digest()
    expected_signature = base64.b64encode(hash).decode('utf-8')
    
    return hmac.compare_digest(signature, expected_signature)
```

#### 7.1.2 å…¥åŠ›å€¤æ¤œè¨¼
```python
def validate_line_input(text):
    """LINEå…¥åŠ›å€¤ã®æ¤œè¨¼"""
    # æœ€å¤§æ–‡å­—æ•°åˆ¶é™
    if len(text) > 2000:
        raise ValueError("å…¥åŠ›ãŒé•·ã™ãã¾ã™ï¼ˆæœ€å¤§2000æ–‡å­—ï¼‰")
    
    # å±é™ºãªæ–‡å­—åˆ—ã®ãƒã‚§ãƒƒã‚¯
    dangerous_patterns = ['<script', 'javascript:', 'data:']
    for pattern in dangerous_patterns:
        if pattern.lower() in text.lower():
            raise ValueError("ä¸æ­£ãªæ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™")
    
    return True
```

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä»•æ§˜

### 8.1 LINE API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
- **ç›®æ¨™**: 3ç§’ä»¥å†…
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 30ç§’
- **æœ€å¤§åŒæ™‚å‡¦ç†**: 10ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’

### 8.2 ãƒ†ã‚­ã‚¹ãƒˆè§£æå‡¦ç†æ™‚é–“
- **ç›®æ¨™**: 100msä»¥å†…
- **ææ–™æ•°åˆ¶é™**: 20å€‹ã¾ã§
- **ãƒ†ã‚­ã‚¹ãƒˆé•·åˆ¶é™**: 2000æ–‡å­—ã¾ã§

## ğŸ†• **9. v3ã§ã®ä¸»è¦å¤‰æ›´ç‚¹**

### 9.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´
- **users ãƒ†ãƒ¼ãƒ–ãƒ«**: `line_user_id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ **: `line_user_id`ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **ãã®ä»–ãƒ†ãƒ¼ãƒ–ãƒ«**: å¤‰æ›´ãªã—

### 9.2 APIè¿½åŠ 
- **æ–°è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: 
  - `/api/external/users/link-line/` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘
  - `/api/external/recipes/from-line/` - LINEãƒ¬ã‚·ãƒ”ç™»éŒ²
  - `/api/external/line/webhook/` - LINE Webhook

### 9.3 æ©Ÿèƒ½è¿½åŠ 
- **ãƒ†ã‚­ã‚¹ãƒˆè§£æ**: LINEç‰¹åŒ–ã®è§£æãƒ­ã‚¸ãƒƒã‚¯
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç´ã¥ã‘çŠ¶æ…‹ç®¡ç†
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: LINEç‰¹æœ‰ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
- **ç½²åæ¤œè¨¼**: LINE Bot API ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 9.4 æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿
- **Webã‚¢ãƒ—ãƒª**: æ—¢å­˜æ©Ÿèƒ½ã¯å¤‰æ›´ãªã—
- **æ—¢å­˜API**: å‹•ä½œã«å½±éŸ¿ãªã—
- **ãƒ‡ãƒ¼ã‚¿**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ãªã—

---

**æœ¬è©³ç´°è¨­è¨ˆæ›¸ï¼ˆv3ï¼‰ã¯LINEé€£æºæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€ãƒãƒ«ãƒãƒãƒ£ãƒãƒ«å¯¾å¿œã®æ‹¡å¼µæ€§ã‚’è©³ç´°ãƒ¬ãƒ™ãƒ«ã§å®Ÿç¾ã™ã‚‹**